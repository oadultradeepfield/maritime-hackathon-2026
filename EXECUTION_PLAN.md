# EXECUTION PLAN — Maritime Fleet Optimisation v5

## Self-Contained Replication Blueprint

> **Purpose**: Any AI agent or developer can follow this document to build the
> complete Maritime Hackathon 2026 solution from scratch, using **only** the two
> provided CSV data files. No other reference material is required.

---

## Table of Contents

1. [Problem Statement](#1-problem-statement)
2. [Directory Structure](#2-directory-structure)
3. [Environment Setup](#3-environment-setup)
4. [Input Data Schemas](#4-input-data-schemas)
5. [Output File Specifications](#5-output-file-specifications)
6. [Solution Architecture Overview](#6-solution-architecture-overview)
7. [Implementation — Section by Section](#7-implementation--section-by-section)
8. [All Constants & Lookup Tables](#8-all-constants--lookup-tables)
9. [Mathematical Formulations](#9-mathematical-formulations)
10. [Validation Checklist](#10-validation-checklist)
11. [Known Pitfalls & Fixes](#11-known-pitfalls--fixes)

---

## 1. Problem Statement

**Challenge**: Given 108 chemical/products tankers with AIS movement data
(13,216 records), select an optimal 20-vessel fleet that:

- Minimises total emissions (CO₂-equivalent)
- Minimises total cost (fuel + ownership + carbon + risk)
- Maintains safety ≥ 3.5 average
- Contains ≥ 3 unique fuel types
- Has total DWT ≥ 2,000,000 tonnes
- Passes regulatory checks (CII 2026, EU ETS, FuelEU Maritime)

**Methodology Core**: IMO 4th GHG Study emission calculation + MILP
optimisation + XGBoost ML augmentation + multi-criteria decision analysis.

---

## 2. Directory Structure

Create the following before running:

```
project_root/
├── vessel_movements_dataset.csv    ← PROVIDED INPUT (13,216 records)
├── llaf_table.csv                  ← PROVIDED INPUT (19 load rows)
├── submission_template.csv         ← PROVIDED (template; overwritten by code)
├── solution_v5.py                  ← MAIN SCRIPT (build from §7)
└── figures/                        ← AUTO-CREATED by script (16 PNG charts)
```

**Output files generated by the script** (all in project_root/):

| File | Description |
|------|-------------|
| `submission_template.csv` | Competition submission (11 header fields) |
| `fleet_details.csv` | 20-vessel fleet with 35+ columns |
| `all_vessels_comparison.csv` | All 108 vessels with TOPSIS scores |
| `voyage_eeoi.csv` | Per-voyage EEOI values |
| `pareto_frontier.csv` | Epsilon-constraint Pareto solutions |
| `regulatory_compliance.csv` | CII + ETS + FuelEU + EVDI per vessel |
| `sensitivity_results.json` | All sensitivity & Monte Carlo results |
| `ml_summary.json` | XGBoost + v5 enhancement metrics |
| `data_quality.csv` | Data quality audit |
| `figures/` | 16 PNG charts (see §7.21) |

---

## 3. Environment Setup

### 3.1 Python Version

- Python ≥ 3.10 (tested on 3.13.5)

### 3.2 Virtual Environment

```bash
cd project_root
python -m venv .venv
source .venv/bin/activate    # macOS/Linux
# .venv\Scripts\activate     # Windows
```

### 3.3 Dependencies

```bash
pip install pandas numpy scikit-learn xgboost pulp matplotlib
```

**macOS only** — XGBoost requires OpenMP:
```bash
brew install libomp
```

### 3.4 Package Versions (tested)

| Package | Version |
|---------|---------|
| pandas | ≥ 2.0 |
| numpy | ≥ 1.24 |
| scikit-learn | ≥ 1.3 |
| xgboost | ≥ 2.0 |
| pulp | ≥ 2.7 |
| matplotlib | ≥ 3.8 |

---

## 4. Input Data Schemas

### 4.1 `vessel_movements_dataset.csv`

13,216 rows × 23 columns. Each row is a timestamped AIS observation.

| # | Column | Type | Example | Description |
|---|--------|------|---------|-------------|
| 0 | `vessel_id` | int | 10498900 | Unique vessel IMO number |
| 1 | `vessel_type_new` | str | Chemical/Products Tanker | Always this value |
| 2 | `timestamp` | str | 2025/03/29 19:02:27+00 | UTC datetime |
| 3 | `timestamp_epoch` | int | 1743274947 | Unix epoch |
| 4 | `latitude` | float | 1.3317 | Decimal degrees |
| 5 | `longitude` | float | 104.66 | Decimal degrees |
| 6 | `speed_knots` | float | 12.59 | Speed over ground |
| 7 | `in_anchorage` | str/null | "anchorage" or null | Anchorage flag |
| 8 | `in_port_boundary` | str/null | "Singapore" or null | Port name |
| 9 | `safety_score` | int | 1–5 | 5 = safest |
| 10 | `dwt` | int | 40483 | Deadweight tonnage |
| 11 | `fuel_category` | int | 2 | Fuel category code |
| 12 | `main_engine_fuel_type` | str | Methanol | One of 9 fuel types |
| 13 | `aux_engine_fuel_type` | str | DISTILLATE FUEL | Auxiliary engine fuel |
| 14 | `boil_engine_fuel_type` | str | DISTILLATE FUEL | Boiler fuel |
| 15 | `engine_type` | str | SSD | "SSD" or "LNG-Diesel" |
| 16 | `mep` | int | 5050 | Main engine power (kW) |
| 17 | `vref` | float | 13.23 | Reference speed (knots) |
| 18 | `sfc_me` | float | 156.7 | Main engine SFC (g/kWh) |
| 19 | `sfc_ae` | float | 209.1 | Aux engine SFC (g/kWh) |
| 20 | `sfc_ab` | float | 300 | Boiler SFC (g/kWh) |
| 21 | `ael` | int | 746 | Aux engine load (kW) |
| 22 | `abl` | int | 125 | Boiler load (kW) |

**Fuel types present**: DISTILLATE FUEL, RESIDUAL FUEL, LNG, Methanol, Ethanol,
LPG (Propane), LPG (Butane), Ammonia, Hydrogen.

**Engine types**: SSD, LNG-Diesel.

### 4.2 `llaf_table.csv`

19 rows × 9 columns. Load-dependent Low-Load Adjustment Factors.

| Column | Type | Description |
|--------|------|-------------|
| `Load` | str | Load percentage, e.g. "2%", "3%", …, "20%" |
| `NOx` | float | LLAF for NOx at that load |
| `HC` | float | LLAF for hydrocarbons |
| `CO` | float | LLAF for CO |
| `PM` | float | LLAF for particulate matter |
| `SO2` | float | LLAF for SOx |
| `CO2` | float | LLAF for CO₂ |
| `N2O` | float | LLAF for N₂O |
| `CH4` | float | LLAF for CH₄ |

**Rule**: If load factor ≥ 20%, LLAF = 1.0. Below 20%, interpolate linearly
from the table. Below the minimum table value (2%), use the 2% factor.

### 4.3 `submission_template.csv`

11 rows. Output format:

| Header Name | Data Type | Units | Notes |
|-------------|-----------|-------|-------|
| team_name | String | - | Your team name |
| category | String | - | "A" |
| report_file_name | String | - | PDF filename |
| sum_of_fleet_deadweight | Float | tonnes | Must ≥ 2,000,000 |
| total_cost_of_fleet | Float | dollars | Fuel cost only for submission |
| average_fleet_safety_score | Float | - | Must ≥ 3.0 |
| no_of_unique_main_engine_fuel_types_in_fleet | Integer | - | Must ≥ 3 |
| sensitivity_analysis_performance | String | Yes/No | "Yes" |
| size_of_fleet_count | Integer | - | 20 |
| total_emission_CO2_eq | Float | tonnes | CO₂-eq TtW |
| total_fuel_consumption | Float | tonnes | Total FC |

---

## 5. Output File Specifications

### 5.1 `fleet_details.csv`

One row per selected vessel (20 rows). Key columns:

```
vessel_id, vessel_type_new, main_fuel, engine_type, dwt, safety,
avg_speed, total_h, distance_nm, n_anomalies,
fc_me, fc_me_physics, fc_ae, fc_bl, fc,
co2, co2eq, co2eq_wtw, co2_wtt, n2o, ch4, nox, sox, pm,
fuel_cost, ownership_cost, carbon_cost, risk_premium, total_cost,
eeoi, cii_attained, cii_ref, cii_rating, cii_margin_pct,
ets_cost_usd, ghg_intensity, fueleu_compliant,
evdi, ghg_rating
```

### 5.2 `all_vessels_comparison.csv`

One row per vessel (108 rows). Includes TOPSIS scores:

```
vessel_id, main_fuel, dwt, safety, n_anomalies,
fc, co2, co2eq, co2eq_wtw,
fuel_cost, ownership_cost, carbon_cost, risk_premium, total_cost,
eeoi, cii_attained, cii_ref, cii_rating,
evdi, ghg_rating,
topsis_score, topsis_rank, d_ideal, d_anti_ideal,
selected (boolean)
```

### 5.3 `pareto_frontier.csv`

One row per Pareto solution (~30 rows, ~29 non-dominated):

```
epsilon, co2eq, fuel_cost, total_cost, carbon_cost, ownership_cost,
safety, dwt, n_fuels, avg_evdi, is_efficient
```

---

## 6. Solution Architecture Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                    SOLUTION PIPELINE (25 Sections)               │
├──────────────────────────────────────────────────────────────────┤
│  §1  Constants & Lookup Tables (IMO 4th GHG Study)              │
│  §2  Data Loading & Validation + Quality Audit                  │
│  §3  Time Intervals (adaptive capping)                          │
│  §4  Isolation Forest AIS Anomaly Detection                     │
│  §5  4-State Operational Machine                                │
│  §6  Voyage Segmentation (state-transition)                     │
│  §7  Physics-Based Emission Engine (+ SFC load correction)      │
│  §8  XGBoost with Temporal Forward-Chaining CV                  │
│  §9  Physics vs ML → Hybrid FC (50/50)                          │
│  §10 TtW + WtW Emission Calculations                           │
│  §11 Per-Vessel Aggregation + EEOI + CII                       │
│  §12 ★ Total Cost Model (fuel + ownership + carbon + risk)      │
│  §13 ★ RightShip EVDI + A-G GHG Rating                         │
│  §14 ★ MILP Fleet Selection (multi-objective + HHI + safety)    │
│  §15 ★ Epsilon-Constraint Pareto Frontier                       │
│  §16 ★ Bertsimas-Sim Robust Optimisation                        │
│  §17 ★ TOPSIS / MCDA Multi-Criteria Ranking                     │
│  §18 Regulatory Compliance (CII + EU ETS + FuelEU Maritime)     │
│  §19 Sensitivity Analysis (5 parameters + carbon price)         │
│  §20 Correlated Monte Carlo (10,000 runs, Cholesky)             │
│  §21 GDSC Singapore-Australia Green Corridor Framing            │
│  §22 16 Charts + Executive Summary Dashboard                    │
│  §23 Submission File                                            │
│  §24 Export Files                                               │
│  §25 Final Summary                                              │
└──────────────────────────────────────────────────────────────────┘
```

---

## 7. Implementation — Section by Section

### § 7.1 — Constants & Lookup Tables

Create all constants at the top of the script. These are **exact values**
and must not be approximated.

#### Carbon Factors (t CO₂ / t fuel) — Tank-to-Wake

```
CF = {
    "DISTILLATE FUEL": 3.206,
    "RESIDUAL FUEL":   3.114,
    "LNG":             2.750,
    "Methanol":        1.375,
    "Ethanol":         1.913,
    "LPG (Propane)":   3.000,
    "LPG (Butane)":    3.030,
    "Ammonia":         0.000,
    "Hydrogen":        0.000,
}
```

#### Well-to-Tank Uplift Factors (WtT CO₂-eq / TtW CO₂)

```
WTT_UPLIFT = {
    "DISTILLATE FUEL": 0.21,
    "RESIDUAL FUEL":   0.19,
    "LNG":             0.23,
    "Methanol":        0.31,
    "Ethanol":         0.15,
    "LPG (Propane)":   0.18,
    "LPG (Butane)":    0.18,
    "Ammonia":         1.83,
    "Hydrogen":        3.50,
}
```

#### N₂O Emission Factors (g/kWh)

```
N2O_EF = {
    "SSD":        {"default": 0.031, "LNG": 0.011, "Hydrogen": 0.0},
    "LNG-Diesel": {"default": 0.031, "LNG": 0.011, "Hydrogen": 0.0},
}
```

#### CH₄ Emission Factors (g/kWh)

**Critical**: LNG has dramatically higher methane slip for LNG-Diesel engines.

```
CH4_EF = {
    "SSD":        {"default": 0.006, "LNG": 5.5,  "Ammonia": 0.0, "Hydrogen": 0.0},
    "LNG-Diesel": {"default": 0.006, "LNG": 18.5, "Ammonia": 0.0, "Hydrogen": 0.0},
}
```

#### NOx, SOx, PM Factors (g/kWh or g/t fuel)

```
NOX_EF = {"SSD": 78.0, "LNG-Diesel": 58.0}

SOX_EF = {  # g SO₂ / t fuel
    "DISTILLATE FUEL": 10.29, "RESIDUAL FUEL": 10.29,
    "LNG": 0.0, "Methanol": 0.0, "Ethanol": 0.0,
    "LPG (Propane)": 0.0, "LPG (Butane)": 0.0,
    "Ammonia": 0.0, "Hydrogen": 0.0,
}

PM_EF = {  # g PM / t fuel
    "DISTILLATE FUEL": 0.80, "RESIDUAL FUEL": 6.20,
    "LNG": 0.02, "Methanol": 0.02, "Ethanol": 0.02,
    "LPG (Propane)": 0.02, "LPG (Butane)": 0.02,
    "Ammonia": 0.00, "Hydrogen": 0.00,
}
```

#### GWP (IPCC AR5)

```
GWP = {"CO2": 1.0, "CH4": 28.0, "N2O": 265.0}
```

#### Fuel Prices ($/tonne)

```
FUEL_PRICE = {
    "DISTILLATE FUEL": 700, "RESIDUAL FUEL": 500,
    "LNG": 600, "Methanol": 450, "Ethanol": 800,
    "LPG (Propane)": 550, "LPG (Butane)": 540,
    "Ammonia": 650, "Hydrogen": 3500,
}
```

#### Auxiliary/Boiler State Multipliers

```
AE_STATE = {"at_sea": 1.0, "maneuvering": 0.70, "berth": 0.40, "anchorage": 0.25}
BL_STATE = {"at_sea": 0.15, "maneuvering": 0.50, "berth": 1.00, "anchorage": 0.80}
```

#### CII Parameters (Chemical Tanker, 2026)

```
CII_REF_A           = 5247.2
CII_REF_C           = 0.610
CII_REDUCTION_2026  = 0.07     # 7% reduction from reference
CII_RATING_BOUNDS   = {"A/B": 0.86, "B/C": 0.94, "C/D": 1.06, "D/E": 1.18}
```

#### FuelEU Maritime

```
FUELEU_GHG_REF       = 91.16    # g CO₂-eq / MJ (2020 baseline)
FUELEU_REDUCTION_2026 = 0.02    # 2% reduction target
FUELEU_TARGET = 91.16 * (1 - 0.02) = 89.3368
FUELEU_PENALTY_PER_GJ = 2400    # €/GJ for non-compliance
```

#### Energy Content (MJ/t fuel)

```
ENERGY_CONTENT = {
    "DISTILLATE FUEL": 42700, "RESIDUAL FUEL": 40200,
    "LNG": 48000, "Methanol": 19900, "Ethanol": 26700,
    "LPG (Propane)": 46300, "LPG (Butane)": 45700,
    "Ammonia": 18600, "Hydrogen": 120000,
}
```

#### Fleet Selection Parameters

```
FLEET_SIZE        = 20
MIN_DWT           = 2_000_000
MIN_SAFETY        = 3.0
MIN_FUEL_TYPES    = 3
CARGO_UTIL        = 0.65
CARBON_PRICE_USD  = 80         # $/t CO₂-eq
HHI_MAX_SHARE     = 0.60       # max fleet share per fuel
EU_ETS_PRICES     = [80, 100, 120, 150]
EUR_USD           = 1.08
```

#### Ownership Cost Function

```python
def ownership_cost_annual(dwt, fuel_type):
    # Base newbuilding price ($M) by DWT range
    if dwt < 10000:   base = 35.0
    elif dwt < 25000: base = 48.0
    elif dwt < 50000: base = 62.0
    else:             base = 85.0

    # Fuel-type ship multiplier
    multipliers = {
        "DISTILLATE FUEL": 1.00, "RESIDUAL FUEL": 1.00,
        "LNG": 1.25, "Methanol": 1.15, "Ethanol": 1.10,
        "LPG (Propane)": 1.20, "LPG (Butane)": 1.20,
        "Ammonia": 1.35, "Hydrogen": 1.40,
    }
    fm = multipliers.get(fuel_type, 1.0)

    # CRF(r=8%, n=25yr) = r(1+r)^n / [(1+r)^n - 1]
    r, n = 0.08, 25
    crf = (r * (1+r)**n) / ((1+r)**n - 1)  # ≈ 0.0937

    opex_rate = 0.035  # 3.5% of capital annually

    return base * 1e6 * fm * (crf + opex_rate)
```

#### Safety Risk Premium Function

```python
def safety_risk_premium_factor(score):
    """Score 1 → 1.10 (+10%), Score 3 → 0.975, Score 5 → 0.95 (-5%)"""
    return 1.0 + (0.1375 - 0.0375 * score)
```

#### SFC Load Correction (IMO Table 62)

```python
def sfc_correction(load_factor):
    if load_factor >= 0.80: return 1.0
    if load_factor <= 0.02: return 1.0
    return 0.455 * load_factor**2 - 0.710 * load_factor + 1.280
```

#### LLAF Interpolation

```python
def get_llaf(load_factor, pollutant="CO2"):
    if load_factor >= 0.20: return 1.0
    # Below table minimum: return first entry
    # Otherwise: numpy.interp from llaf_table values
```

---

### § 7.2 — Data Loading

```python
df = pd.read_csv("vessel_movements_dataset.csv", usecols=range(23))
llaf_raw = pd.read_csv("llaf_table.csv")
```

- Parse `Load` column: strip "%" → float / 100
- Build LLAF lookup dict: `{pollutant: (load_factors_array, factors_array)}`
- Parse timestamps: `pd.to_datetime(timestamp, format="mixed", utc=True)`
- Sort by `(vessel_id, timestamp)`
- Data quality audit: count nulls, speed outliers >20 kn, speed = 0

---

### § 7.3 — Time Intervals

**Goal**: Compute `dt_h` (hours between consecutive AIS records per vessel).

```python
df["dt_h"] = groupby("vessel_id")["timestamp"].diff().dt.total_seconds() / 3600
df["dt_h"].fillna(1.0)

# Adaptive capping: cap = 3 × vessel median, clipped to [1.5, 6.0] hours
median_dt = groupby("vessel_id")["dt_h"].transform("median")
cap = (3.0 * median_dt).clip(lower=1.5, upper=6.0)
df["dt_h"] = df["dt_h"].clip(upper=cap)

# Flag large gaps (> 2× vessel median)
df["gap_flag"] = df["dt_h"] > 2.0 * median_dt
```

---

### § 7.4 — Isolation Forest Anomaly Detection

**Purpose**: Identify AIS data anomalies (spoofing, GPS errors, transmission
artifacts).

**Features** (4):
1. `speed_knots` — raw reported speed
2. `dt_h` — time gap
3. `pos_change` — Euclidean distance in degrees: √(Δlat² + Δlon²)
4. `speed_over_pos` — ratio: speed / (pos_change × 60), with safeguard for zero

**Model**:
```python
IsolationForest(n_estimators=200, contamination=0.03, random_state=42, n_jobs=-1)
```

**Post-processing**: Replace anomalous speeds with vessel median speed.

**Expected result**: ~397 anomalies (~3%).

---

### § 7.5 — Operational State Machine

Classify each AIS record into one of 4 states:

```
if in_anchorage == "anchorage"  → "anchorage"
elif in_port_boundary not null:
    if speed < 1.0 kn           → "berth"
    else                        → "maneuvering"
else                            → "at_sea"
```

Typical distribution: at_sea ~70%, anchorage ~15%, berth ~10%, maneuvering ~5%.

---

### § 7.6 — Voyage Segmentation

**Algorithm**: Detect transitions from non-sea → sea states.

```python
for each vessel (sorted by timestamp):
    if current state is "at_sea" AND previous state was NOT "at_sea":
        increment voyage counter
```

Record per voyage: vessel_id, voyage_id, n_records, sea_records, duration_h,
sea_h, avg_sea_speed, distance_nm.

**Expected**: ~210 total voyages, ~111 with meaningful sea data.

---

### § 7.7 — Physics-Based Emission Engine

This is the **core emission calculation** per the IMO 4th GHG Study.

#### 7.7.1 Load Factor

```
speed_ratio = speed_clean / vref
load_factor = speed_ratio³  (propeller cube law)
```

- Cap `speed_ratio` at 1.10 before cubing → max LF = 1.331
- If `speed_clean < 0.5 kn` → LF = 0 (vessel effectively stationary)
- If `speed_clean ≥ 0.5` but LF < 0.02 → floor at 0.02

#### 7.7.2 SFC Correction

Apply `sfc_correction(LF)` to main engine SFC. This increases SFC at low loads
(partial-load penalty).

```
sfc_me_corrected = sfc_me × sfc_correction(LF)
```

#### 7.7.3 LLAF

Apply `get_llaf(LF, pollutant)` for each pollutant (CO₂, NOx, PM, CH₄, N₂O, SOx).

#### 7.7.4 Main Engine Fuel Consumption

```
FC_ME = MEP × LF × SFC_corrected × dt_h × LLAF_CO2 × 10⁻⁶    [tonnes]
```

If `speed_clean < 0.5 kn` → FC_ME = 0.

#### 7.7.5 Auxiliary Engine Fuel Consumption

```
FC_AE = AEL × AE_mult(state) × SFC_AE × dt_h × 10⁻⁶
```

Where `AE_mult` comes from the state multiplier table (§7.1).

#### 7.7.6 Boiler Fuel Consumption

```
FC_BL = ABL × BL_mult(state) × SFC_AB × dt_h × 10⁻⁶
```

---

### § 7.8 — XGBoost with Temporal CV

**Purpose**: Learn residual patterns that physics cannot capture.

#### Features (16)

```python
feature_cols = [
    "speed_clean", "mep", "vref", "sfc_me_corrected", "dwt",
    "dt_h", "latitude", "longitude",
    "fuel_enc", "engine_enc", "state_enc",    # LabelEncoded
    "speed_ratio", "pos_change",
    "acceleration",         # Δspeed / dt_h
    "speed_rolling_std",    # rolling(5).std()
    "days_since_start",     # temporal feature
]
```

#### Target

`fc_me_physics` (from §7.7) — train ML to predict physics output.

#### Training data

Only moving records: `speed_clean >= 0.5`.

#### Model config

```python
XGBRegressor(
    n_estimators=300, max_depth=6, learning_rate=0.05,
    subsample=0.8, colsample_bytree=0.8,
    reg_alpha=0.1, reg_lambda=1.0,
    random_state=42, n_jobs=-1,
)
```

#### Validation

`TimeSeriesSplit(n_splits=5)` — forward-chaining CV.

**Expected**: R² ≈ 0.994, MAE ≈ 0.0001 tonnes.

---

### § 7.9 — Physics-ML Hybrid

```python
fc_me_hybrid = 0.5 × fc_me_physics + 0.5 × fc_me_ml
```

For non-moving records (`speed < 0.5`), use physics only.

---

### § 7.10 — TtW + WtW Emissions

#### Tank-to-Wake CO₂

```
CO2_TtW = FC_ME × CF_ME + FC_AE × CF_AE + FC_BL × CF_BL
```

#### N₂O (tonnes)

```
N2O = (FC_ME × EF_N2O_ME + FC_AE × 0.031) × 10⁻³
```

Where EF_N2O_ME depends on engine type and fuel type (lookup from N2O_EF dict).

#### CH₄ (tonnes)

```
CH4 = (FC_ME × EF_CH4_ME + FC_AE × 0.006) × 10⁻³
```

Where EF_CH4_ME depends on engine type and fuel type (lookup from CH4_EF dict).

#### CO₂-equivalent (TtW)

```
CO2eq_TtW = CO2_TtW × GWP_CO2 + CH4 × GWP_CH4 + N2O × GWP_N2O
          = CO2_TtW × 1.0 + CH4 × 28.0 + N2O × 265.0
```

#### Well-to-Tank

```
WtT_ME = FC_ME × WTT_UPLIFT(fuel) × CF(fuel)
```

**Special case**: If CF = 0 (Ammonia, Hydrogen), use:
```
WtT_ME = FC_ME × WTT_UPLIFT(fuel)
```

```
CO2_WtW = CO2_TtW + WtT_ME + WtT_AE
CO2eq_WtW = CO2eq_TtW + CO2_WtT
```

#### NOx, SOx, PM

```
NOx = (FC_ME × LLAF_NOx/LLAF_CO2 + FC_AE) × NOX_EF(engine) × 10⁻³
SOx = (FC_ME × SOX_EF(fuel_ME) + FC_AE × SOX_EF(fuel_AE)) × 10⁻³
PM  = (FC_ME × PM_EF(fuel_ME) + FC_AE × PM_EF(fuel_AE)) × 10⁻³
```

#### Fuel Cost

```
fuel_cost = FC_ME × PRICE(fuel_ME) + FC_AE × PRICE(fuel_AE) + FC_BL × PRICE(fuel_BL)
```

---

### § 7.11 — Per-Vessel Aggregation + EEOI + CII

Group by `vessel_id`, sum all fuel/emission/cost fields.

#### Distance

```
distance_nm = avg_sea_speed × total_sea_hours
```

#### EEOI

```
cargo_t = dwt × CARGO_UTIL (= dwt × 0.65)
transport_work = cargo_t × distance_nm
EEOI = CO2 × 10⁶ / transport_work    [g CO₂ / (t × nm)]
```

#### CII

```
CII_attained = CO2 × 10⁶ / (DWT × distance_nm)
CII_ref = 5247.2 × DWT^(-0.610) × (1 - 0.07)

ratio = CII_attained / CII_ref
→ A if ratio ≤ 0.86
→ B if ratio ≤ 0.94
→ C if ratio ≤ 1.06
→ D if ratio ≤ 1.18
→ E otherwise
```

#### Per-Voyage EEOI

Compute EEOI for each voyage (≥3 sea records), then average per vessel.

---

### § 7.12 — Total Cost Model (v5)

```
total_cost = fuel_cost + ownership_cost + carbon_cost + risk_premium
```

Where:
- `ownership_cost` = `ownership_cost_annual(dwt, main_fuel)` (see §7.1)
- `carbon_cost` = `co2eq × $80/t`
- `risk_factor` = `safety_risk_premium_factor(safety_score)` (see §7.1)
- `risk_premium` = `(fuel_cost + ownership_cost) × (risk_factor − 1.0)`

---

### § 7.13 — RightShip EVDI + GHG Rating

#### EVDI Calculation

```
EVDI = (SFC_design × CF × MEP) / (DWT × Vref)   [gCO₂ / (t × nm)]
```

Where SFC_design = the vessel's original SFC (not corrected).

#### GHG Rating (A–G)

Based on **percentile within the 108-vessel fleet**:

```
≤ 10th percentile → A
≤ 25th percentile → B
≤ 40th percentile → C
≤ 55th percentile → D
≤ 70th percentile → E
≤ 85th percentile → F
> 85th percentile → G
```

---

### § 7.14 — MILP Fleet Optimisation

**This is the most critical section. The formulation must be exact.**

#### Objective — Normalised Multi-Objective

**DO NOT use raw total_cost as objective** — ownership cost dominates (~97%)
and causes the solver to pick smallest/cheapest vessels, ignoring emissions.

```
min  Σᵢ [ W_CO2 × norm_co2ᵢ + W_COST × norm_costᵢ + W_SAFE × safety_penᵢ ] × xᵢ
```

Where:
- `W_CO2 = 0.55, W_COST = 0.25, W_SAFE = 0.20`
- `norm_co2ᵢ = (co2eqᵢ − min) / (max − min)` across all 108 vessels
- `norm_costᵢ = (total_costᵢ − min) / (max − min)` across all 108 vessels
- `safety_penᵢ = (5 − safetyᵢ) / 4` — higher penalty for lower safety

#### Constraints

**C1: Fleet size = 20**
```
Σᵢ xᵢ = 20
```

**C2: Minimum DWT**
```
Σᵢ (dwtᵢ × xᵢ) ≥ 2,000,000
```

**C3: Linearised safety constraint**
```
Σᵢ (safetyᵢ − 3.5) × xᵢ ≥ 0
```

This elegantly enforces weighted average ≥ 3.5 without non-linear division.
Vessels with safety > 3.5 contribute positively; < 3.5 contribute negatively.

**C4: Fuel diversity (≥ 3 unique fuel types)**

Use binary indicator variables `y_f ∈ {0,1}` for each fuel type f:
```
y_f ≤ Σ(xᵢ for i using fuel f)           # y_f can only be 1 if at least one
y_f × |{i: fuel_i = f}| ≥ Σ(xᵢ for i using fuel f)  # y_f must be 1 if any selected
Σ_f y_f ≥ 3
```

**C5: HHI fuel concentration cap**

No single fuel type can have > 60% of fleet (= 12 vessels):
```
∀f: Σ(xᵢ for i using fuel f) ≤ ⌈0.60 × 20⌉ = 12
```

#### Solver

```python
pulp.PULP_CBC_CMD(msg=0)
```

---

### § 7.15 — Epsilon-Constraint Pareto Frontier

**Sweep 30 values of ε from 0.95 × min_possible_co2 to 1.05 × max_possible_co2.**

For each ε:

```
min  Σᵢ total_costᵢ × xᵢ
s.t.
    Σᵢ xᵢ = 20
    Σᵢ dwtᵢ × xᵢ ≥ 2,000,000
    Σᵢ (safetyᵢ − 3.5) × xᵢ ≥ 0
    fuel diversity ≥ 2  (relaxed for Pareto exploration)
    Σᵢ co2eqᵢ × xᵢ ≤ ε    ← EPSILON CONSTRAINT
```

After solving all ε values, identify **non-dominated** solutions:
Solution j dominates solution i if j has ≤ cost AND ≤ emissions with at least
one strict inequality.

**Expected**: ~29 non-dominated Pareto points.

---

### § 7.16 — Bertsimas-Sim Robust Optimisation

**Fuel prices are uncertain within ±20%, but at most Γ=2 fuel types deviate.**

#### Robust Counterpart

```
min  Σᵢ total_costᵢ × xᵢ + Γ × π + Σ_f ρ_f
s.t.
    π + ρ_f ≥ p̂_f × Σ(fuel_costᵢ × xᵢ for i using fuel f)   ∀f
    π ≥ 0, ρ_f ≥ 0  ∀f
    + all standard fleet constraints (C1–C5)
```

Where `p̂_f = 0.20` (maximum fractional price deviation).

**This is LP-tractable** — auxiliary variables π and ρ_f make the robust
counterpart linear despite the uncertainty set.

Report: nominal cost, robust objective, uncertainty premium (Δ), overlap
with deterministic fleet.

---

### § 7.17 — TOPSIS / MCDA

**5 criteria** with weights:

| Criterion | Direction | Weight |
|-----------|-----------|--------|
| CO₂-eq | min | 0.30 |
| Total cost | min | 0.25 |
| Safety | max | 0.20 |
| EVDI | min | 0.15 |
| CII ratio | min | 0.10 |

#### Steps

1. **Normalise**: Vector normalisation: `r_ij = x_ij / √(Σᵢ x_ij²)`
2. **Weight**: `v_ij = w_j × r_ij`
3. **Ideal** (A⁺): Best value per criterion (min for cost criteria, max for benefit)
4. **Anti-ideal** (A⁻): Worst value per criterion
5. **Distance**: `D⁺ᵢ = √(Σⱼ (v_ij − A⁺ⱼ)²)`, `D⁻ᵢ = √(Σⱼ (v_ij − A⁻ⱼ)²)`
6. **Closeness**: `Cᵢ = D⁻ᵢ / (D⁺ᵢ + D⁻ᵢ)` — higher is better

Rank all 108 vessels. Compare TOPSIS top-20 with MILP fleet.
Report agreement percentage.

---

### § 7.18 — Regulatory Compliance

For each selected vessel:

1. **CII margin**: `(1 − CII_attained/CII_ref) × 100%`
2. **EU ETS cost**: `CO₂ × €100 × 1.08 $/€` (base price €100/t)
3. **FuelEU GHG intensity**: `CO₂eq × 10⁶ / (FC × ENERGY_CONTENT(fuel))` [g/MJ]
4. **FuelEU compliant**: if GHG intensity ≤ 89.34 g/MJ

---

### § 7.19 — Sensitivity Analysis

5 parameters:

| Parameter | Variations |
|-----------|-----------|
| **a) Slow steaming** | Speed: -5%, -10%, -15%, -20%, -25% |
| **b) EU ETS price** | €80, €100, €120, €150 per tonne |
| **c) Fuel price** | -20%, -10%, +10%, +20%, +30% |
| **d) Safety threshold** | Min safety ≥ 2, 3, 4, 5 |
| **e) Carbon price** | $40, $60, $80, $100, $120, $150 per tonne |

For slow steaming: recompute LF with adjusted speed, apply SFC correction,
recalculate FC and CO₂.

---

### § 7.20 — Correlated Monte Carlo

**10,000 runs** with Cholesky-decomposed correlated uncertainties.

#### Correlation matrix (4 × 4)

```
         Speed   SFC    Weather  FuelPrice
Speed    [1.00   0.10   0.05     0.35]
SFC      [0.10   1.00   0.15     0.05]
Weather  [0.05   0.15   1.00     0.00]
FuelPrice[0.35   0.05   0.00     1.00]
```

#### Standard deviations

```
Speed: 5%, SFC: 3%, Weather: 10%, FuelPrice: 15%
```

#### Per simulation

```python
z = N(0,1) × 4 random variates
correlated = means(=1) + L @ (z × stds)   # L = cholesky(corr_matrix)
speed_var = max(correlated[0], 0.3)
load_exp = speed_var³
mc_co2 = BASE_CO2 × load_exp × sfc_var × weather_var
mc_cost = BASE_FUEL_COST × load_exp × sfc_var × weather_var × price_var
mc_total = mc_cost + ownership + (mc_co2 × co2eq/BASE_CO2 × $80) + risk_prem
```

Report: P5, P50, P95, 95% CI for CO₂ and costs.

#### Tornado chart

Compute swing for each parameter at ±1σ:
- Speed ±5%: CO₂ × (0.95³ vs 1.05³)
- SFC ±3%: CO₂ × (0.97 vs 1.03)
- Weather ±10%: CO₂ × (0.90 vs 1.10)
- Fuel price ±15%: cost × (0.85 vs 1.15)
- Carbon ±25%: carbon_cost × (0.75 vs 1.25)

---

### § 7.21 — GDSC Green Corridor Framing

Compute and report:

```python
gdsc = {
    "alternative_fuel_pct": % of fleet NOT using distillate/residual,
    "zero_ttw_vessels": count using Ammonia or Hydrogen,
    "lng_ready": count using LNG,
    "cii_abc_pct": % of fleet with CII rating A, B, or C,
    "avg_evdi": fleet average EVDI,
    "readiness": "HIGH" if alt_fuel > 50%, else "MODERATE"
}
```

---

### § 7.22 — Charts (16 figures)

Generate all charts to `figures/` directory. Use `matplotlib Agg` backend.

| # | Filename | Content |
|---|----------|---------|
| 1 | `fleet_fuel_mix.png` | Pie chart: fuel type distribution |
| 2 | `co2eq_vs_cost.png` | Scatter: CO₂-eq vs total cost (selected highlighted) |
| 3 | `montecarlo.png` | 2-panel histogram: CO₂ + total cost with 95% CI |
| 4 | `slow_steaming.png` | Line: speed reduction vs CO₂ |
| 5 | `cii_ratings.png` | Bar: CII A/B/C/D/E distribution |
| 6 | `tornado.png` | Tornado: parameter sensitivity swings |
| 7 | `ml_vs_physics.png` | Scatter: physics FC vs hybrid correction |
| 8 | `feature_importance.png` | Horizontal bar: XGBoost features |
| 9 | `anomaly_detection.png` | Scatter: speed vs position change (anomalies red) |
| 10 | `voyage_eeoi.png` | Box plot: per-voyage EEOI for top 15 vessels |
| 11 | `pareto_frontier.png` | Pareto front: cost vs CO₂-eq, selected fleet starred |
| 12 | `topsis_distance.png` | Scatter: D⁺ vs D⁻, coloured by TOPSIS score |
| 13 | `cost_breakdown.png` | Stacked bar: fuel/ownership/carbon/risk per vessel |
| 14 | `evdi_ghg_rating.png` | 2-panel: EVDI histogram + GHG rating pie |
| 15 | `executive_summary.png` | 9-panel dashboard (KPIs, fuel mix, CII, costs, etc.) |
| 16 | `voyage_eeoi.png` | (same as 10 — only generated if voyage data exists) |

**Note**: Use `marker="*"` not `"★"` — matplotlib doesn't support Unicode markers.

---

### § 7.23–25 — Submission, Export, Summary

- Write `submission_template.csv` with the 11 header fields
- Export all CSV/JSON files listed in §2
- Print final summary with all metrics

---

## 8. All Constants & Lookup Tables

All constants are specified inline in §7.1. There are **no hidden constants**.
Every value used in the computation is documented in this plan.

---

## 9. Mathematical Formulations

### 9.1 Propeller Cube Law

$$FC_{ME} = MEP \cdot LF \cdot SFC_{corr} \cdot \Delta t \cdot LLAF \cdot 10^{-6}$$

Where: $LF = \left(\frac{V}{V_{ref}}\right)^3$

### 9.2 SFC Load Correction (IMO Table 62)

$$SFC_{corr}(LF) = 0.455 \cdot LF^2 - 0.710 \cdot LF + 1.280 \quad \text{for } 0.02 \leq LF < 0.80$$

### 9.3 CO₂-Equivalent

$$CO_2eq_{TtW} = CO_2 \cdot 1.0 + CH_4 \cdot 28.0 + N_2O \cdot 265.0$$

### 9.4 CII Reference Line (Chemical Tanker, 2026)

$$CII_{ref} = 5247.2 \cdot DWT^{-0.610} \cdot (1 - 0.07)$$

### 9.5 MILP Normalised Objective

$$\min \sum_{i} \left[ 0.55 \cdot \tilde{e}_i + 0.25 \cdot \tilde{c}_i + 0.20 \cdot \frac{5 - s_i}{4} \right] x_i$$

Where $\tilde{e}_i$, $\tilde{c}_i$ are min-max normalised emissions and costs.

### 9.6 Linearised Safety

$$\sum_{i} (s_i - 3.5) \cdot x_i \geq 0$$

### 9.7 Capital Recovery Factor

$$CRF(r, n) = \frac{r(1+r)^n}{(1+r)^n - 1}$$

With $r = 0.08$, $n = 25$: $CRF \approx 0.0937$

### 9.8 EVDI

$$EVDI = \frac{SFC \cdot CF \cdot MEP}{DWT \cdot V_{ref}} \quad \left[\frac{gCO_2}{t \cdot nm}\right]$$

### 9.9 TOPSIS Closeness

$$C_i = \frac{D^-_i}{D^+_i + D^-_i}$$

### 9.10 Bertsimas-Sim Robust Counterpart

$$\min \sum_i c_i x_i + \Gamma \pi + \sum_f \rho_f$$
$$\text{s.t. } \pi + \rho_f \geq \hat{p}_f \sum_{i \in F_f} c^{fuel}_i x_i \quad \forall f$$

---

## 10. Validation Checklist

After running the script, verify:

| Check | Expected |
|-------|----------|
| Fleet size | Exactly 20 |
| DWT total | ≥ 2,000,000 t |
| Safety average | ≥ 3.5 |
| Fuel types | ≥ 3 unique |
| No single fuel > 60% | ≤ 12 vessels per fuel |
| CII ratings exist | A through E assigned |
| FuelEU calculated | Compliance flag per vessel |
| Pareto solutions | ~25–30, ≥20 non-dominated |
| TOPSIS scores | Range [0, 1], higher = better |
| Monte Carlo | 10,000 runs, CI widths reasonable |
| Robust premium | Should be small (< 1% of cost) |
| All output files | 9 files + figures/ directory |
| submission_template.csv | 11 rows, correct format |

---

## 11. Known Pitfalls & Fixes

### 11.1 CRITICAL — MILP Objective Dominance

**Problem**: If you use raw `total_cost` as the MILP objective, ownership cost
(~$190M) dwarfs fuel cost (~$1.9M) by 100×. The solver picks the 20 smallest/
cheapest vessels regardless of emissions, producing CO₂-eq ~8,500t (terrible).

**Fix**: Use normalised multi-objective with weights W_CO2=0.55, W_COST=0.25,
W_SAFE=0.20. This balances emissions, economics, and safety.

### 11.2 XGBoost on macOS

XGBoost requires `libomp` (OpenMP) on macOS:
```bash
brew install libomp
```

### 11.3 Matplotlib Unicode Markers

Use `marker="*"` not `marker="★"`. Matplotlib raises `ValueError` for
Unicode characters as markers.

### 11.4 WtT for Zero-CF Fuels

Ammonia and Hydrogen have CF = 0. The WtT formula must special-case this:
```python
if CF == 0:
    wtt = FC × WTT_UPLIFT   # not × CF
else:
    wtt = FC × WTT_UPLIFT × CF
```

### 11.5 LLAF Table Parsing

The `Load` column has "%" suffix — strip it before converting to float.

### 11.6 CSV Extra Columns

`vessel_movements_dataset.csv` may have trailing empty columns. Use
`usecols=range(23)` to read only the first 23.

### 11.7 Fuel Indicator Constraints

The MILP fuel diversity constraint needs both upper and lower bounds on
the indicator variable `y_f` to be mathematically tight:
- `y_f ≤ Σ x_i` (can't indicate without selection)
- `y_f × N_f ≥ Σ x_i` (must indicate if any selected)

---

*This plan is complete. An AI agent following these instructions step-by-step
will produce an identical solution. All constants, formulas, constraints,
and algorithms are specified without ambiguity.*
